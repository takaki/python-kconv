PYTHON_VER = @pythonver@

KCONV_VERSION = "1.1.8c"
KSTRING_VERSION = "0.2.0c"

prefix = @prefix@
exec_prefix = @exec_prefix@
PYTHON_H = @includedir@/python$(PYTHON_VER)
INSTALLDIR = @libdir@/python$(PYTHON_VER)/site-packages

#Make .pyc and .pyo file.
PYTHONFILES = defaults.py kconvtools.py __init__.py
PYTHONOBJS = $(patsubst %.py, %.pyc, $(PYTHONFILES))
ifeq "@OPTIMIZE@" "yes"
PYTHONOBJS += $(patsubst %.py, %.pyo, $(PYTHONFILES))
endif

CPPFLAGS = @CPPFLAGS@ @CCSHARED@ -Wall
LIBS = @LIBS@
LIBOBJS = @LIBOBJS@
DATAFILES = kconvu2etable.dat kconve2utable.dat kconveuctable2.dat kconvsjistable2.dat
INSTDIR = $(INSTALLDIR)/kconv
SRCDIR = src
WINSRCDIR = winsrc
SO=@SO@

DTARGET = kconv@SO@
KDTARGET = kstring@SO@

CC = @CC@
RM = @RM@
LD = @LD@
CP = @CP@
TAR = @TAR@
TEST = @TEST@
MKDIR = @MD@
PYTHON = @PYTHON@
INSTALL = @INSTALL@
LDSHARED = @LDSHARED@

NO_C_O=@NO_MINUS_C_MINUS_O@

MAKEOPT = prefix=$(prefix) \
			exec_prefix=$(exec_prefix) \
			PYTHON_H=$(PYTHON_H) \
			INSTALLDIR=$(INSTALLDIR) \
			KCONV_VERSION=$(KCONV_VERSION) \
			KSTRING_VERSION=$(KSTRING_VERSION) \
			LDSHARED="$(LDSHARED)" \
			CPPFLAGS="$(CPPFLAGS)" \
			LIBS="$(LIBS)" \
			LIBOBJS="$(LIBOBJS)" \
			SO="$(SO)"

# all: depend doall pycompile
all: doall pycompile
	cd $(SRCDIR);$(MAKE) $(MAKEOPT) all

doall:
	cd $(SRCDIR);$(MAKE) $(MAKEOPT) all

compile: pycompile
	cd $(SRCDIR);$(MAKE) $(MAKEOPT) compile

# depend:
#	cd $(SRCDIR);$(MAKE) $(MAKEOPT) depend

pycompile: $(PYTHONOBJS)

clean: srcclean
	$(RM) -f $(DTARGET)
	$(RM) -f $(KDTARGET)
	$(RM) -f *.pyc *.pyo
	$(RM) -f *~

configclean:
	$(RM) -f config.*
	$(RM) -f configure.h
	$(RM) -f Makefile

distclean: clean srcdistclean configclean winsrcclean

srcclean:
	cd $(SRCDIR);$(MAKE) $(MAKEOPT) clean

srcdistclean:
	cd $(SRCDIR);$(MAKE) $(MAKEOPT) distclean

install: all
	$(RM) -fR $(INSTDIR)
	$(MKDIR) $(INSTDIR)
	$(INSTALL) $(DTARGET) $(INSTDIR)
	$(INSTALL) $(PYTHONFILES) $(INSTDIR)
	$(INSTALL) $(PYTHONOBJS) $(INSTDIR)
	$(INSTALL) $(DATAFILES) $(INSTDIR)

%.pyc:%.py
	$(PYTHON) -c "import py_compile;py_compile.compile('$<')"

%.pyo:%.py
	$(PYTHON) -O -c "import py_compile;py_compile.compile('$<')"

doccopy:
	$(TEST) -d ../doc && $(CP) ../doc/* ./ || echo "docs not found."

win32src:
	$(TEST) ! -d $(WINSRCDIR) && $(MKDIR) $(WINSRCDIR) || echo $(WINSRCDIR) exists.
	$(TAR) cf - -C $(SRCDIR) . | $(TAR) xpf - -C $(WINSRCDIR)
	$(TAR) cf - $(PYTHONFILES) | $(TAR) xpf - -C $(WINSRCDIR)	
	rm -f $(WINSRCDIR)/*.so $(WINSRCDIR)/*.o $(WINSRCDIR)/*~ $(WINSRCDIR)/*.d
	cd $(WINSRCDIR);blconv *.cpp *.h $(PYTHONFILES)

winsrcclean:
	$(RM) -fR $(WINSRCDIR)

package: doccopy win32src srcclean clean configclean
	cd ../;$(TAR) czpvf kconv-$(KCONV_VERSION).tar.gz ./kconv
	cd ../;lha c kconv-$(KCONV_VERSION).lzh ./kconv
